{% extends "base.html" %}

{% block title %}Оплата - Школьная столовая{% endblock %}

{% block content %}
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">Успешно</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">Операция успешна!</div>
    </div>
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-danger text-white">
            <i class="bi bi-exclamation-circle me-2"></i>
            <strong class="me-auto">Ошибка</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="errorToastMessage">Произошла ошибка!</div>
    </div>
</div>

<div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-credit-card text-primary"></i> Оплата
            </h2>
            <p class="text-muted mb-0">Пополнение баланса и покупка абонемента</p>
        </div>
        <div class="mt-2 mt-sm-0">
            <a href="/student/dashboard" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-arrow-left me-1"></i> Назад к панели
            </a>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-sm-6">
        <div class="stat-card stat-card-info">
            <div class="stat-icon">
                <i class="bi bi-wallet2"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Баланс кошелька</div>
                <div class="stat-value" id="walletBalance">Загрузка...</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6">
        <div class="stat-card stat-card-primary">
            <div class="stat-icon">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">Статус абонемента</div>
                <div class="stat-value" id="subscriptionStatus">Загрузка...</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="content-card">
            <div class="content-card-header">
                <div class="d-flex align-items-center">
                    <div class="header-icon header-icon-success">
                        <i class="bi bi-cash-coin"></i>
                    </div>
                    <h5 class="mb-0">Пополнить кошелек</h5>
                </div>
            </div>
            <div class="content-card-body">
                <p class="text-muted mb-3">Пополните баланс кошелька для оплаты блюд без оформления абонемента.</p>
                <form id="topUpForm">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Сумма пополнения (₽)</label>
                        <div class="input-group mb-3">
                            <input type="number" class="form-control form-control-lg" id="topUpAmount" min="100" step="100" value="500" required>
                            <span class="input-group-text">₽</span>
                        </div>
                        <div class="quick-amount-buttons mb-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="setTopUpAmount(500)">500 ₽</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="setTopUpAmount(1000)">1000 ₽</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="setTopUpAmount(2000)">2000 ₽</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setTopUpAmount(5000)">5000 ₽</button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-plus-circle me-2"></i> Пополнить кошелек
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="content-card">
            <div class="content-card-header">
                <div class="d-flex align-items-center">
                    <div class="header-icon">
                        <i class="bi bi-cart-plus"></i>
                    </div>
                    <h5 class="mb-0" id="subscriptionCardTitle">Купить абонемент</h5>
                </div>
            </div>
            <div class="content-card-body">
                <p class="text-muted mb-3" id="subscriptionCardDescription">Оформите абонемент для регулярного питания в столовой.</p>
                <form id="subscriptionForm">
                    <div class="subscription-options mb-3">
                        <div class="form-check subscription-option mb-2">
                            <input class="form-check-input" type="radio" name="subscriptionType" id="subWeekly" value="weekly" checked>
                            <label class="form-check-label w-100" for="subWeekly">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="fw-semibold">Недельный абонемент</span>
                                        <p class="mb-0 small text-muted">5 блюд на неделю</p>
                                    </div>
                                    <span class="badge bg-primary fs-6">700 ₽</span>
                                </div>
                            </label>
                        </div>
                        <div class="form-check subscription-option">
                            <input class="form-check-input" type="radio" name="subscriptionType" id="subMonthly" value="monthly">
                            <label class="form-check-label w-100" for="subMonthly">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="fw-semibold">Месячный абонемент</span>
                                        <p class="mb-0 small text-muted">20 блюд на месяц</p>
                                    </div>
                                    <span class="badge bg-success fs-6">2500 ₽</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="subscriptionSubmitBtn">
                        <i class="bi bi-check-circle me-2"></i> Купить абонемент
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadWallet();
    loadSubscription();
    
    function showToast(message, isError = false) {
        const toastId = isError ? 'errorToast' : 'successToast';
        const messageId = isError ? 'errorToastMessage' : 'toastMessage';
        document.getElementById(messageId).textContent = message;
        const toast = new bootstrap.Toast(document.getElementById(toastId));
        toast.show();
    }
    
    document.getElementById('topUpForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const amount = document.getElementById('topUpAmount').value;
        
        try {
            const response = await Auth.apiCall('/api/wallet/topup', {
                method: 'POST',
                body: JSON.stringify({ 
                    amount: parseFloat(amount)
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showToast('Кошелек успешно пополнен!');
                loadWallet();
                document.getElementById('topUpAmount').value = '500';
            } else {
                showToast(data.error || 'Ошибка при пополнении кошелька', true);
            }
        } catch (error) {
            showToast('Ошибка сети. Попробуйте снова.', true);
        }
    });
    
    document.getElementById('subscriptionForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const type = document.querySelector('input[name="subscriptionType"]:checked').value;
        
        try {
            const subResponse = await Auth.apiCall('/api/subscription');
            const subData = await subResponse.json();
            const hasActiveSubscription = subData.subscription && subData.subscription.is_active;
            
            const response = await Auth.apiCall('/api/subscription', {
                method: 'POST',
                body: JSON.stringify({ subscription_type: type })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                const message = hasActiveSubscription ? 'Абонемент успешно продлен!' : 'Абонемент успешно приобретен!';
                showToast(message);
                loadSubscription();
                loadWallet();
            } else {
                showToast(data.error || 'Ошибка при покупке', true);
            }
        } catch (error) {
            showToast('Ошибка сети. Попробуйте снова.', true);
        }
    });
});

function setTopUpAmount(amount) {
    document.getElementById('topUpAmount').value = amount;
}

async function loadWallet() {
    const balanceEl = document.getElementById('walletBalance');
    
    try {
        const response = await Auth.apiCall('/api/wallet');
        
        if (response.ok) {
            const data = await response.json();
            const balance = data.wallet ? data.wallet.balance : 0;
            balanceEl.textContent = balance + ' ₽';
        } else {
            balanceEl.textContent = '0 ₽';
        }
    } catch (error) {
        console.error('Error loading wallet:', error);
        balanceEl.textContent = '0 ₽';
    }
}

async function loadSubscription() {
    const statusEl = document.getElementById('subscriptionStatus');
    const cardTitle = document.getElementById('subscriptionCardTitle');
    const cardDescription = document.getElementById('subscriptionCardDescription');
    const submitBtn = document.getElementById('subscriptionSubmitBtn');
    
    try {
        const response = await Auth.apiCall('/api/subscription');
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.subscription && data.subscription.is_active) {
                const typeNames = {
                    'weekly': 'Недельный',
                    'monthly': 'Месячный'
                };
                statusEl.textContent = typeNames[data.subscription.subscription_type] || 'Активен';
                
                cardTitle.textContent = 'Продлить абонемент';
                cardDescription.textContent = 'Продлите существующий абонемент для продолжения питания в столовой.';
                submitBtn.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i> Продлить абонемент';
            } else {
                statusEl.textContent = 'Нет абонемента';
                
                cardTitle.textContent = 'Купить абонемент';
                cardDescription.textContent = 'Оформите абонемент для регулярного питания в столовой.';
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i> Купить абонемент';
            }
        }
    } catch (error) {
        console.error('Error loading subscription:', error);
        statusEl.textContent = 'Нет абонемента';
    }
}
</script>
{% endblock %}
